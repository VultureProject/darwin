# FAUP
FROM ubuntu:18.04 AS faup_builder
ARG FAUP_VERSION

WORKDIR /root
RUN apt-get update && apt-get install -y --no-install-recommends\
 ca-certificates\
 wget\
 cmake\
 g++\
 pkg-config
RUN wget https://github.com/stricaud/faup/archive/v${FAUP_VERSION}.tar.gz \
 && mkdir faup \
 && tar xvf v${FAUP_VERSION}.tar.gz -C faup --strip-components 1 \
 && mkdir faup/build || true \
 && cd faup/build \
 && cmake .. \
 && make -j4 install DESTDIR=../install



# BOOST
FROM ubuntu:18.04 as boost_builder
ARG BOOST_VERSION

WORKDIR /root
RUN apt-get update && apt-get install -y --no-install-recommends\
 wget\
 cmake\
 g++\
 pkg-config\
 ca-certificates
RUN BOOST_UNDERSCORE_VERSION=`echo ${BOOST_VERSION} | tr . _` \
 && wget https://dl.bintray.com/boostorg/release/${BOOST_VERSION}/source/boost_${BOOST_UNDERSCORE_VERSION}.tar.gz \
 && mkdir boost \
 && tar xvf boost_${BOOST_UNDERSCORE_VERSION}.tar.gz -C boost --strip-components 1 \
 && cd boost \
 && ./bootstrap.sh --with-libraries="math,program_options,serialization,system,test,date_time" --prefix=./install  \
 && ./b2 install



# MLPACK
FROM ubuntu:18.04 AS mlpack_builder
ARG ARMADILLO_VERSION
ARG MLPACK_VERSION

WORKDIR /root
COPY --from=boost_builder /root/boost/install/ /usr/local/
RUN apt-get update && apt-get install -y --no-install-recommends\
 wget\
 cmake\
 make\
 xz-utils\
 gcc\
 g++\
 git\
 liblapacke-dev\
 libopenblas-dev\
 ca-certificates
RUN wget https://sourceforge.net/projects/arma/files/armadillo-${ARMADILLO_VERSION}.tar.xz \
 && mkdir armadillo-code \
 && tar xvf armadillo-${ARMADILLO_VERSION}.tar.xz -C armadillo-code --strip-components 1
RUN wget https://github.com/mlpack/mlpack/archive/${MLPACK_VERSION}.tar.gz \
 && mkdir mlpack \
 && tar xvf ${MLPACK_VERSION}.tar.gz -C mlpack --strip-components 1 \
 && cd mlpack\
 && mkdir build\
 && cd build\
 && cmake .. -DBUILD_TESTS=OFF -DBUILD_CLI_EXECUTABLES=OFF -DBUILD_PYTHON_BINDINGS=OFF -DFORCE_CXX11=ON -DUSE_OPENMP=ON -DBUILD_SHARED_LIBS=OFF -DARMADILLO_INCLUDE_DIR=/root/armadillo-code/include/ -DCMAKE_INSTALL_PREFIX:PATH=../install\
 && make -j16 install


# YARA
FROM ubuntu:18.04 AS yara_builder
ARG YARA_VERSION

WORKDIR /root
RUN apt-get update && apt-get install -y --no-install-recommends \
 ca-certificates\
 libjansson-dev\
 libmagic-dev\
 libssl-dev\
 libpcre3\
 make\
 g++\
 gcc\
 pkg-config\
 wget\
 autoconf\
 automake\
 libtool

RUN wget https://github.com/VirusTotal/yara/archive/v${YARA_VERSION}.tar.gz \
 && mkdir yara \
 && tar xvf v${YARA_VERSION}.tar.gz -C yara --strip-components 1 \
 && cd yara\
 && ./bootstrap.sh\
 && ./configure\
 && make -j4 install DESTDIR=`pwd`/install



# DARWIN dev image
FROM ubuntu:18.04 AS darwin_builder

RUN mkdir -p var/sockets/darwin \
 && mkdir -p /var/run/darwin \
 && mkdir -p /var/log/darwin

RUN apt-get update && apt-get install -y --no-install-recommends \
 ca-certificates\
 libevent-dev\
 libmaxminddb-dev\
 libhiredis-dev\
 libssl-dev\
 liblapacke-dev\
 libopenblas-dev\
 cmake\
 pkg-config\
 g++\
 git\
 redis\
 python3-dev\
 python3-pip\
 python3-setuptools\
 python3-wheel

COPY --from=faup_builder /root/faup/install/ /
COPY --from=mlpack_builder /root/mlpack/install/ /
COPY --from=mlpack_builder /root/armadillo-code/ /root/armadillo-code/
COPY --from=boost_builder /root/boost/install/ /usr/local/
COPY --from=yara_builder /root/yara/install/ /

COPY . /home/darwin
WORKDIR /home/darwin

RUN mkdir filters || rm -rf filters/*\
 && cd filters \
 && cmake .. -DARMADILLO_INCLUDE_DIR=/root/armadillo-code/include/\
 && make -j4
RUN pip3 install -r manager/requirements.txt\
 && pip3 install -r tests/requirements.txt



FROM ubuntu:18.04 AS darwin
RUN mkdir -p /var/sockets/darwin \
 && mkdir -p /var/run/darwin \
 && mkdir -p /var/log/darwin

RUN apt-get update && apt-get install -y --no-install-recommends \
 libevent-2.1 \
 libmaxminddb0 \
 libhiredis0.13 \
 liblapacke \
 libopenblas-base \
 libgomp1 \
 python3 \
 python3-pip \
 python3-setuptools \
 python3-wheel \
 python3-psutil \
 python3-redis

RUN pip3 install jsonschema==3.2.0

COPY --from=faup_builder /root/faup/install/usr/local/lib/libfaup* /usr/local/lib/
COPY --from=faup_builder /root/faup/install/usr/local/share/faup/ /usr/local/share/faup
COPY --from=yara_builder /root/yara/install/usr/local/lib/libyara* /usr/local/lib/
COPY --from=darwin_builder /home/darwin/filters/darwin_* /home/darwin/filters/
COPY --from=darwin_builder /home/darwin/manager /home/darwin/manager
COPY --from=darwin_builder /home/darwin/conf /home/darwin/conf

RUN find /home/darwin/conf/ -type f -exec bash -c 'mv $0 ${0/.example/}' {} \;

WORKDIR /home/darwin
ENV LOGLEVEL WARNING
CMD sh -c "python3 ./manager/manager.py -l ${LOGLEVEL} /home/darwin/conf/darwin.conf"
VOLUME ["/home/darwin/conf"]
VOLUME ["/var/sockets/darwin"]
VOLUME ["/var/log/darwin"]

# define default final image
FROM darwin