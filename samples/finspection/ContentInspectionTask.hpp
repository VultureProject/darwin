/// \file     ContentInspection.hpp
/// \authors  jjourdin
/// \version  1.0
/// \date     10/09/18
/// \license  GPLv3
/// \brief    Copyright (c) 2018 Advens. All rights reserved.

#pragma once

#include <string>
#include <set>

#include "../../toolkit/lru_cache.hpp"
#include "../../toolkit/rapidjson/stringbuffer.h"
#include "../../toolkit/rapidjson/writer.h"
#include "protocol.h"
#include "Session.hpp"

#include "tcp_sessions.hpp"
#include "stream_buffer.hpp"
#include "flow.hpp"
#include "yara_utils.hpp"
#include "extract_impcap.hpp"

#define DARWIN_FILTER_CONTENT_INSPECTION 0x79617261
#define DARWIN_FILTER_NAME "inspection"
#define DARWIN_ALERT_RULE_NAME "YARA Network Packet & Stream Inspection"
#define DARWIN_ALERT_TAGS "[]"

typedef struct Configurations_t {
    StreamsCnf *streamsCnf;
    FlowCnf *flowCnf;
    YaraCnf *yaraCnf;
}Configurations;

// To create a usable task method you MUST inherit from darwin::thread::Task publicly.
// The code bellow show all what's necessary to have a working task.
// For more information about Tasks, please refer to the class definition.

class ContentInspectionTask : public darwin::Session {
public:
    explicit ContentInspectionTask(boost::asio::local::stream_protocol::socket& socket,
                            darwin::Manager& manager,
                            std::shared_ptr<boost::compute::detail::lru_cache<xxh::hash64_t, unsigned int>> cache,
				std::mutex& _cache_mutex,
                            Configurations& configurations);

    ~ContentInspectionTask() override = default;

public:
    // You need to override the functor to compile and be executed by the thread
    void operator()() override;

protected:
    /// Return filter code
    long GetFilterCode() noexcept override;

private:
    /// According to the header response,
    /// init the following Darwin workflow
    void Workflow();

    /// Parse the body received.
    bool ParseBody() override;

    /// Convert a std::set to string json list
    std::string GetJsonListFromSet(std::set<std::string> &input);

    // Implemented but not used.
    bool ParseLine(rapidjson::Value& line __attribute__((unsused))) final {return true;}

private:
    Configurations _configurations;
    std::vector<Packet *> _packetList;
};
